- name: Create Ansible user on Mikrotik
  become: true
  become_method: ansible.netcommon.enable
  hosts: routeros
  gather_facts: false
  vars:
    mikrotik_user_name: "Ansible"
    mikrotik_user_pass: ""
    mikrotik_user_group: "ssh-key-only"
    mikrotik_user_group_pol: "ssh, local"
    mikrotik_user_crt: ""
    mikrotik_user_crt_file: "user_crt.txt"
  tasks:
    - name: Create  new Group
      community.routeros.command: 
        commands: "/user group add name={{ mikrotik_user_group }} policy={{ mikrotik_user_group_pol }}"
        
    - name: Create crt file
      community.routeros.command: 
        commands: "/file print file={{ mikrotik_user_crt_file }}"
        
    - name: Add public key to file
      community.routeros.command: 
        commands: '/file set {{ mikrotik_user_crt_file }} contents="{{ mikrotik_user_crt }}"'

    - name: Create Ansible user
      community.routeros.command:
        commands: "/user/add name={{ mikrotik_user_name }} group=full password={{ mikrotik_user_pass }}"

    - name: Add Ansible user certificate
      community.routeros.command:
        commands: "/user/ssh-keys/import public-key-file={{ mikrotik_user_crt_file }} user={{ mikrotik_user_name }}"
        
    - name: Add Ansible user to Group
      community.routeros.command:
        commands: "/user set [find name={{ mikrotik_user_name }}] group=ssh-key-only"
    - name: Debug vars
      debug:
        msg: "{{ mikrotik_user_name }}, {{ mikrotik_user_pass }}, {{ mikrotik_user_group }}, {{ mikrotik_user_group_pol }}, {{ mikrotik_user_crt }}, {{ mikrotik_user_crt_file }}"
