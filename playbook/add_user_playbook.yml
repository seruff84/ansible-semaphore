- name: Create Ansible user on Mikrotik
  become: true
  become_method: ansible.netcommon.enable
  hosts: routeros
  gather_facts: false
  vars:
    mikrotik_ansible_crt: "crt.txt"
    mikrotik_ansible_user: "ansible"
    mikrotik_ansible_pass: "{{mikrotik_password}}"
  tasks:
    - name: Create crt file
      community.routeros.command: 
        commands: "/file print file={{ mikrotik_ansible_crt }}"
    - name: Add public key to file
      community.routeros.command: 
        commands: '/file set {{ mikrotik_ansible_crt }} contents="{{ ssh_key }}"'

    - name: Create Ansible user
      community.routeros.command:
        commands: "/user/add name={{ mikrotik_ansible_user }} group=full password={{ mikrotik_ansible_pass }}"

    - name: Add Ansible user certificate
      community.routeros.command:
        commands: "/user/ssh-keys/import public-key-file={{ mikrotik_ansible_crt }} user={{ mikrotik_ansible_user }}"
